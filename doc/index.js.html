<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: index.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: index.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>'use strict'
const onFinished = require('on-finished')
const pub = require('./pub')
const net = require('./net')
const ApexStore = require('./store')
/**
 * ActivitypubExpress module
 * @module activitypub-express */

/**
 * @typedef ApexRequest
 * @property {ApexInstance} app.locals.apex - 
 */

/**
 * @callback ApexInstance
 * @param {object} req - Express request object
 * @param {object} res - Express response object
 * @param {function} next - Express next callback
 * @property {ApexOptions} settings
 * @property {module:net} net - apex middlewares module
 * @property {IApexSore} store - the storage instance
 * 
 */

/**
 * Initialize an apex instance
 * @param  {ApexOptions} settings
 * @returns {ApexInstance} use the returned middleware globally in your express app before any other apex middlewares
 */
module.exports = function Apex (settings) {
  const apex = function (req, res, next) {
    req.app.locals.apex = apex // apex api object
    res.locals.apex = {
      eventName: null,
      eventMessage: {},
      postWork: []
    }
    onFinished(res, onFinishedHandler)
    next()
  }
  // bind pub methods at top level so their 'this' is apex instance
  for (const prop in pub) {
    if (typeof pub[prop] === 'function') {
      apex[prop] = pub[prop].bind(apex)
    } else {
      apex[prop] = pub[prop]
    }
  }
  apex.settings = settings
  apex.domain = settings.domain
  apex.context = settings.context
    ? pub.consts.ASContext.concat(settings.context)
    : pub.consts.ASContext
  apex.net = net
  apex.store = settings.store || new ApexStore()
  apex.actorParam = settings.actorParam
  apex.objectParam = settings.objectParam
  apex.activityParam = settings.activityParam || settings.objectParam
  apex.collectionParam = settings.collectionParam || settings.objectParam
  apex.pageParam = settings.pageParam || 'page'
  apex.itemsPerPage = settings.itemsPerPage || 20
  apex.threadDepth = settings.threadDepth || 10
  apex.systemUser = settings.systemUser
  apex.logger = settings.logger || console
  apex.offlineMode = settings.offlineMode
  /**
   * Instance-specific utility functions
   * @type {object}
   */
  apex.utils = {
    usernameToIRI: apex.idToIRIFactory(apex.domain, settings.routes.actor, apex.actorParam),
    objectIdToIRI: apex.idToIRIFactory(apex.domain, settings.routes.object, apex.objectParam),
    activityIdToIRI: apex.idToIRIFactory(apex.domain, settings.routes.activity, apex.activityParam),
    userCollectionIdToIRI: apex.userAndIdToIRIFactory(apex.domain, settings.routes.collections, apex.actorParam, apex.collectionParam),
    nameToActorStreams: apex.nameToActorStreamsFactory(apex.domain, settings.routes, apex.actorParam),
    nameToBlockedIRI: apex.idToIRIFactory(apex.domain, settings.routes.blocked, apex.actorParam),
    nameToRejectedIRI: apex.idToIRIFactory(apex.domain, settings.routes.rejected, apex.actorParam),
    nameToRejectionsIRI: apex.idToIRIFactory(apex.domain, settings.routes.rejections, apex.actorParam),
    idToActivityCollections: apex.idToActivityCollectionsFactory(apex.domain, settings.routes, apex.activityParam),
    iriToCollectionInfo: apex.iriToCollectionInfoFactory(apex.domain, settings.routes, apex.actorParam, apex.activityParam, apex.collectionParam)
  }

  function onFinishedHandler (err, res) {
    if (err) return
    const apexLocal = res.locals.apex
    Promise.all(apexLocal.postWork.map(task => task.call(res)))
      .then(() => {
        if (apexLocal.eventName) {
          res.app.emit(apexLocal.eventName, apexLocal.eventMessage)
        }
      })
      .catch(err => {
        apex.logger.error('post-response error:', err.message)
      })
  }

  return apex
}
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Modules</h3><ul><li><a href="module-activitypub-express.html">activitypub-express</a></li><li><a href="module-net.html">net</a></li><li><a href="module-net_validators.html">net/validators</a></li><li><a href="module-store_interface.html">store/interface</a></li></ul><h3>Classes</h3><ul><li><a href="module-store_interface.html">store/interface</a></li></ul><h3>Global</h3><ul><li><a href="global.html#addToOutbox">addToOutbox</a></li><li><a href="global.html#publishActivity">publishActivity</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 3.6.6</a> on Fri Mar 19 2021 16:37:21 GMT-0500 (Central Daylight Time)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
